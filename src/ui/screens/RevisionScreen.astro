---
import '../../styles/global.css';
import '../../styles/screens/revision.css';
---

<div class="screen revision-screen" id="revisionScreen">
    <div class="revision-header">
        <button class="back-btn" onclick="window.game.goHome()">‚Üê HOME</button>
        <h2>ENCYCLOPEDIA</h2>
        <div class="search-bar">
            <input type="text" id="revSearch" placeholder="Search terms or questions...">
        </div>
    </div>
    
    <div class="revision-content" id="revisionContent">
        <!-- Dynamic Content -->
    </div>
</div>



<script>
    class RevisionController {
        private content: HTMLElement;
        private search: HTMLInputElement;
        private items: any[] = [];

        constructor() {
            this.content = document.getElementById('revisionContent')!;
            this.search = document.getElementById('revSearch') as HTMLInputElement;
            
            this.init();
        }
        
        init() {
            // @ts-ignore
            const sd = window.subjectData;
            console.log("Revision Screen Init. Subject Data:", sd);
            
            if(!sd) {
                console.error("No subject data found.");
                return;
            }
            
            // Merge Terminology and Questions for search?
            // "Encyclopedia" usually implies Terms.
            this.items = sd.terminology || [];
            if(this.items.length === 0) {
                 console.warn("No terminology data found in subject.");
                 this.content.innerHTML = "<div class='rev-item'>No terminology data available.</div>";
                 return;
            }
            
            this.render();
            
            this.render();
            
            this.search.addEventListener('input', () => this.render());
            
            // Listen for late-loaded data
            window.addEventListener('game-assets-ready', (e: any) => {
                 console.log("RevisionScreen: Data Refreshed");
                 // @ts-ignore
                 const sd = window.subjectData;
                 if(sd && sd.terminology) {
                     this.items = sd.terminology;
                     // Reset "No data" message if present
                     this.render();
                 }
            });
        }
        
        render() {
            const query = this.search.value.toLowerCase();
            const filtered = this.items.filter((t: any) => 
                t.term.toLowerCase().includes(query) || 
                t.definition.toLowerCase().includes(query)
            );
            
            this.content.innerHTML = filtered.map((t: any) => `
                <div class="rev-item">
                    <div class="rev-term">${t.term}</div>
                    <div class="rev-def">${t.definition}</div>
                </div>
            `).join('');
        }
    }
    
    // Defer init
    document.addEventListener('DOMContentLoaded', () => {
         // @ts-ignore
         // We might need to wait for subjectData?
         // Assuming Layout loads it before DOMContentLoaded or very early.
         new RevisionController();
    });
</script>
