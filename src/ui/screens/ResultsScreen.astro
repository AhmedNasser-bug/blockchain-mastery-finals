---
import '../../styles/screens/results.css';
---
<div class="screen" id="resultsScreen">
    <div class="container container-narrow">
        <div class="card results-container">
            <div class="results-header">
                <div>
                    <h2 class="mission-title">MISSION REPORT</h2>
                    <p class="mission-status">CLEARANCE LEVEL: MAX</p>
                </div>
                </div>
                <div class="grade-box">
                    <div class="grade-label">GRADE</div>
                    <div id="finalGrade" class="grade-value">?</div>
                </div>
            </div>
            
            <div class="report-grid">
                <!-- Accuracy -->
                <div class="report-cell cell-border-right cell-border-bottom">
                    <div class="stat-lbl text-muted">ACCURACY</div>
                    <div id="finalScore" class="stat-val">0%</div>
                </div>
                <!-- Time -->
                <div class="report-cell cell-border-bottom">
                    <div class="stat-lbl text-muted">DURATION</div>
                    <div id="finalTime" class="stat-val">00:00</div>
                </div>
                 <!-- Correct -->
                <div class="report-cell cell-border-right">
                    <div class="stat-lbl text-success">SUCCESSFUL</div>
                    <div id="correctCount" class="stat-val">0</div>
                </div>
                <!-- Incorrect -->
                <div class="report-cell">
                    <div class="stat-lbl text-error">FAILED</div>
                    <div id="incorrectCount" class="stat-val">0</div>
                </div>
            </div>

            <div class="action-buttons">
                 <button class="btn btn-secondary review-btn" onclick="window.game.showReview()">
                    REVIEW LOGS
                </button>
                <button class="btn btn-primary return-btn" onclick="window.game.goHome()">
                    RETURN TO BASE
                </button>
            </div>
        </div>
    </div>

    <div class="card review-container hidden" id="reviewContainer">
        <div class="review-header">
             <h3 class="review-title">MISSION DEBRIEF</h3>
        </div>
        <div id="reviewContent" class="review-content"></div>
         <button class="btn btn-secondary close-btn" onclick="document.getElementById('reviewContainer').classList.add('hidden')">CLOSE DEBRIEF</button>
    </div>
</div>



<script>
    import { DatabaseService } from '../../infrastructure/db/DatabaseService';
    // We can also import Player or specific Stats entity if we had it.
    // For now, let's assume we save runs via DB service or Player Logic.
    
    export interface QuizResults {
        score: number;
        total: number;
        time: number;
        answers: any[];
        maxStreak: number;
        mode?: string;
    }

    class ResultsScreenController {
        constructor() {
            // @ts-ignore
            window.game = window.game || {};
            // @ts-ignore
            window.game.showResults = this.display.bind(this);
            // @ts-ignore
            window.game.showReview = this.showReview.bind(this);
        }

        async display(results: QuizResults) {
            this.showScreen('resultsScreen');

            const percentage = Math.round((results.score / results.total) * 100);
            
             // @ts-ignore
            window.lastQuizResults = results;
            
            // SAVE PROGRESS (DB)
            // @ts-ignore
            const subjectId = window.subjectData.id;
            const run = {
                player_id: 1, // Default Guest
                subject_id: subjectId,
                score: percentage,
                questions_answered: results.total,
                questions_correct: results.score, // raw score = count
                time_taken: results.time,
                mode: results.mode || 'quiz',
                timestamp: Date.now()
            };
            
            try {
                // We use DatabaseService directly or via Player entity.
                // Doing raw insert for now to fix the break.
                // Ideally: await Player.getById(1).addRun(run);
                const db = DatabaseService.getInstance();
                await db.run(
                    `INSERT INTO player_stats (player_id, subject_id, score, questions_answered, questions_correct, time_taken, mode, timestamp)
                     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
                    [run.player_id, run.subject_id, run.score, run.questions_answered, run.questions_correct, run.time_taken, run.mode, run.timestamp]
                );
                console.log("Results saved to DB");
            } catch(e) {
                console.error("Failed to save results:", e);
            }

            const elFinalScore = document.getElementById('finalScore');
            if (elFinalScore) elFinalScore.textContent = percentage + '%';

            const elCorrect = document.getElementById('correctCount');
            if (elCorrect) elCorrect.textContent = results.score.toString();

            const elIncorrect = document.getElementById('incorrectCount');
            if (elIncorrect) elIncorrect.textContent = (results.total - results.score).toString();

            const elTime = document.getElementById('finalTime');
            if (elTime) elTime.textContent = this.formatTime(results.time);

            this.updateGrade(percentage);
        }

        showScreen(id: string) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id)?.classList.add('active');
        }

        showReview(): void {
            // @ts-ignore
            const results = window.lastQuizResults;
            if(!results) return;

            const container = document.getElementById('reviewContainer');
            if (container) container.classList.remove('hidden');

            const content = document.getElementById('reviewContent');
            if (content) {
                content.innerHTML = results.answers.map((ans: any, idx: number) => `
                    <div class="review-item ${ans.correct ? 'review-correct' : 'review-incorrect'}">
                        <div class="review-question">${idx + 1}. ${ans.question}</div>
                        <div class="review-answer">Your Answer: ${this.formatAnswer(ans.userAnswer)}</div>
                        <div class="review-answer">Correct: ${this.formatAnswer(ans.correctAnswer)}</div>
                        <div class="review-explanation">${ans.explanation}</div>
                    </div>
                `).join('');
            }
        }
        
        private formatAnswer(ans: any): string {
            if(typeof ans === 'object') return JSON.stringify(ans);
            return ans;
        }

        private updateGrade(score: number): void {
            const el = document.getElementById('finalGrade');
            if (!el) return;
            
            el.className = 'grade-value'; 
            let grade = 'F';
            let gradeClass = 'grade-f';
            
            if (score >= 97) { grade = 'S+'; gradeClass = 'grade-s-plus'; }
            else if (score >= 93) { grade = 'S'; gradeClass = 'grade-s'; }
            else if (score >= 90) { grade = 'A+'; gradeClass = 'grade-a-plus'; }
            else if (score >= 87) { grade = 'A'; gradeClass = 'grade-a'; }
            else if (score >= 80) { grade = 'B'; gradeClass = 'grade-b'; }
            else if (score >= 70) { grade = 'C'; gradeClass = 'grade-c'; }
            else if (score >= 60) { grade = 'D'; gradeClass = 'grade-d'; }
            
            el.textContent = grade;
            el.classList.add(gradeClass);
        }

        private formatTime(secs: number): string {
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new ResultsScreenController();
    });
</script>
