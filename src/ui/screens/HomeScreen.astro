---
import { SUBJECT_MODES } from "../../data/subjects/Subject";
interface Props {
    subjectName: string;
    description: string;
}
const { subjectName, description } = Astro.props;
---

<div class="screen active" id="homeScreen">
    <div class="header">
        <h1 class="hero-title">{subjectName.toUpperCase()}</h1>
         <div class="hero-subtitle-container">
            <div class="separator-line"></div>
            <p class="subtitle-text">MASTERY PROTOCOL V2</p>
        </div>
        <p class="description-text">{description}</p>
    </div>

    <!-- Stats Ticker / Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">TOTAL RUNS</div>
            <div class="stat-value" id="totalRuns">0</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">BEST SCORE</div>
            <div class="stat-value" id="bestScore">0%</div>
        </div>
        <div class="stat-card">
             <div class="stat-label">AVERAGE</div>
            <div class="stat-value" id="avgScore">0%</div>
        </div>
        <div class="stat-card">
             <div class="stat-label">STREAK</div>
            <div class="stat-value" id="bestStreak">0</div>
        </div>
        <div class="stat-card awards-card" onclick="window.game.showAchievements()">
             <div class="stat-label">AWARDS</div>
            <div class="stat-value" id="totalAwards">üèÜ</div>
        </div>
    </div>

    <div class="card selector-container">
        <h2 class="section-title">SELECT OPERATIONAL MODE</h2>
        <div class="mode-selector">
            {
                Object.values(SUBJECT_MODES).map((mode) => (
                    <div
                        class="mode-btn"
                        data-mode={mode.id}
                        onclick={
                            mode.componentId === "FlashcardScreen"
                                ? `window.game.startFlashcards('${mode.id === "flashcards-bank" ? "questionBank" : "terminology"}')`
                                : `window.game.selectMode('${mode.id}')`
                        }
                    >
                        <div class="mode-icon">{mode.icon}</div>
                        <div>
                            <h3 class="mode-title">{mode.label}</h3>
                            <p class="mode-desc">{mode.description}</p>
                        </div>
                    </div>
                ))
            }
        </div>

        <div id="categorySelector" class="category-selector-container">
            <h3 class="category-selector-title">TARGET SECTOR</h3>
            <div class="category-grid" id="categoryGrid"></div>
        </div>

        <div class="start-btn-group">
            <button
                class="btn btn-secondary encyclopedia-btn"
                onclick="window.game.showRevisionScreen()"
                id="revisionBtn"
            >
                üìñ ENCYCLOPEDIA (REF)
            </button>
            <button
                class="btn btn-primary start-challenge-btn"
                onclick="window.game.startQuiz()"
            >
                INITIALIZE CHALLENGE
            </button>
        </div>
    </div>

    <div class="card history-card">
        <div class="history-header">
            <h2>OPERATION LOGS</h2>
        </div>
        <div id="historyContainer">
            <p class="empty-history">
                AWAITING DATA...
            </p>
        </div>
    </div>
</div>

<style>
    .hero-title {
        font-size: 6rem;
        line-height: 0.9;
    }

    .hero-subtitle-container {
        display: flex;
        gap: 20px;
        align-items: center;
        margin-top: 20px;
    }

    .separator-line {
        height: 4px;
        background: var(--primary);
        flex-grow: 1;
    }

    .subtitle-text {
        margin: 0;
        font-weight: bold;
        color: var(--primary);
        letter-spacing: 2px;
    }

    .description-text {
        margin-top: 20px;
        font-size: 1.2rem;
        border-left: none;
        padding: 0;
        max-width: 100%;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        border: 2px solid var(--border);
        background: var(--bg-card);
        gap: 1px;
        background-color: var(--border);
        margin-bottom: 40px;
    }

    .stat-card {
        background: var(--bg-card);
        /* Padding likely handled by global .stat-card or inherited, usually needs padding if not globally defined */
        /* Checking generic .stat-card definition in globals if exists, otherwise assume defaults or add padding */
        padding: 20px; /* Safety add */
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .awards-card {
        cursor: pointer;
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        font-weight: bold;
        letter-spacing: 1px;
    }
    
    .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        font-family: 'JetBrains Mono', monospace;
    }

    .selector-container {
        border: none;
        background: transparent;
        padding: 0;
        box-shadow: none;
    }

    .section-title {
        font-size: 2rem;
        border-bottom: 2px solid var(--border);
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .mode-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
    }

    .mode-btn {
        text-align: left;
        padding: 30px;
        border: 2px solid var(--border);
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg-card);
    }
    
    /* Hover effects for mode-btn provided by logic or global? Adding here for completeness if needed, or relying on global */
    .mode-btn:hover, .mode-btn.selected {
        border-color: var(--primary);
    }

    .mode-icon {
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .mode-title {
        font-size: 1.5rem;
        color: var(--text-primary);
        margin-bottom: 5px;
    }

    .mode-desc {
        font-size: 0.9rem;
        color: var(--text-muted);
    }

    .category-selector-container {
        display: none; /* logic toggles this */
        margin-top: 30px;
    }
    
    .category-selector-title {
        margin-bottom: 15px;
        font-size: 1.2rem;
        color: var(--text-muted);
    }

    .category-grid {
        display: grid; 
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
        gap: 10px;
    }
    
    .category-card {
        border: 1px solid var(--border);
        padding: 15px;
        cursor: pointer;
        background: var(--bg-card);
    }

    .start-btn-group {
        margin-top: 40px;
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 20px;
    }

    .encyclopedia-btn {
        height: 80px;
        font-size: 1.2rem;
    }

    .start-challenge-btn {
        height: 80px;
        font-size: 2rem;
        letter-spacing: 2px;
    }

    .history-card {
        margin-top: 60px;
        border: 2px solid var(--border);
        border-radius: 0;
        padding: 0; /* Override default card padding if needed for inner structure */
    }

    .history-header {
        background: var(--bg-card-hover);
        padding: 15px;
        border-bottom: 2px solid var(--border);
    }

    .history-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }

    .empty-history {
        color: var(--text-muted);
        text-align: center;
        padding: 20px;
    }
</style>

<script>
    import type { SubjectData as Subject } from "../../data/subjects/Subject";
    import { SUBJECT_MODES } from "../../data/subjects/Subject";

    class HomeScreenController {
        private subject: Subject;
        private currentMode: string = "speedrun";
        private selectedCategory: string | null = null;

        constructor() {
            // @ts-ignore
            this.subject = window.subjectData;
            this.bindEvents();
            this.init();
        }

        bindEvents() {
            // @ts-ignore
            window.game = window.game || {};
            // @ts-ignore
            window.game.startQuiz = this.startChallenge.bind(this);
            // @ts-ignore
            window.game.selectMode = this.selectMode.bind(this);
            // @ts-ignore
            window.game.selectCategory = this.selectCategory.bind(this);
            // @ts-ignore
            window.game.updateStats = this.updateStats.bind(this);
            // @ts-ignore
            window.game.loadHistory = this.loadHistory.bind(this);
            // @ts-ignore
            window.game.goHome = this.goHome.bind(this);
        }

        goHome() {
            document
                .querySelectorAll(".screen")
                .forEach((s) => s.classList.remove("active"));
            document.getElementById("homeScreen")?.classList.add("active");
            this.updateStats();
            this.loadHistory();
        }

        startChallenge() {
            if (this.currentMode === 'survival') {
                // @ts-ignore
                if(window.game.startSurvival) window.game.startSurvival();
            } else {
                // @ts-ignore
                if(window.game.startStandardGame) window.game.startStandardGame(this.currentMode);
            }
        }

        init() {
            this.updateStats();
            this.loadHistory();
            this.renderCategories();
        }

        selectMode(mode: string) {
            this.currentMode = mode;
            document.querySelectorAll(".mode-btn").forEach((btn: any) => {
                btn.classList.toggle("selected", btn.dataset.mode === mode);
            });

            const categorySelector =
                document.getElementById("categorySelector");
            if (categorySelector) {
                categorySelector.style.display =
                    mode === "practice" ? "block" : "none";
            }
        }

        selectCategory(category: string) {
            this.selectedCategory = category;
            document.querySelectorAll(".category-card").forEach((card: any) => {
                const title = card.querySelector("h3")?.textContent;
                // @ts-ignore
                card.style.borderColor =
                    title === category ? "var(--primary)" : "var(--border)";
                // @ts-ignore
                card.style.background =
                    title === category
                        ? "rgba(255, 215, 0, 0.1)"
                        : "var(--bg-card)";
            });
        }

        private updateStats() {
            const data = this.loadProgress();

            const elRuns = document.getElementById("totalRuns");
            if (elRuns) elRuns.textContent = data.runs.length.toString();

            const elBestScore = document.getElementById("bestScore");
            if (elBestScore) elBestScore.textContent = data.bestScore + "%";

            const elBestStreak = document.getElementById("bestStreak");
            if (elBestStreak)
                elBestStreak.textContent = data.bestStreak.toString();

            if (data.runs.length > 0) {
                const avg = Math.round(
                    data.runs.reduce((a: number, b: any) => a + b.score, 0) /
                        data.runs.length,
                );
                const elAvg = document.getElementById("avgScore");
                if (elAvg) elAvg.textContent = avg + "%";
            }

            const awardCount = data.achievements ? data.achievements.length : 0;
            const totalAwards = this.subject.achievements?.length || 0;
            const awardEl = document.getElementById("totalAwards");
            if (awardEl)
                awardEl.textContent = `üèÜ ${awardCount}/${totalAwards}`;
        }

        private loadHistory() {
            const data = this.loadProgress();
            const container = document.getElementById("historyContainer");
            if (!container) return;

            if (data.runs.length === 0) {
                container.innerHTML =
                    '<p class="empty-history">No runs yet. Start your first challenge!</p>';
                return;
            }

            const recentRuns = data.runs.slice(-10).reverse();
            let html =
                '<table class="history-table"><thead><tr><th>Date</th><th>Mode</th><th>Score</th><th>Time</th><th>Grade</th></tr></thead><tbody>';

            recentRuns.forEach((run: any) => {
                const grade = this.getGrade(run.score);
                const badgeClass =
                    run.score >= 87
                        ? "badge-success"
                        : run.score >= 70
                          ? "badge-warning"
                          : "badge-error";
                html += `<tr><td>${new Date(run.date).toLocaleDateString()}</td><td style="text-transform:capitalize">${run.mode}</td><td><strong>${run.score}%</strong></td><td>${this.formatTime(run.time)}</td><td><span class="badge ${badgeClass}">${grade}</span></td></tr>`;
            });

            html += "</tbody></table>";
            container.innerHTML = html;
        }

        private renderCategories() {
            const grid = document.getElementById("categoryGrid");
            if (!grid) return;

            const categories = [
                ...new Set(this.subject.questions.map((q) => q.category)),
            ];
            grid.innerHTML = categories
                .map((cat) => {
                    const count = this.subject.questions.filter(
                        (q) => q.category === cat,
                    ).length;
                    return `<div class="category-card" data-cat="${cat}" onclick="window.game.selectCategory('${cat}')"><h3>${cat}</h3><span>${count} questions</span></div>`;
                })
                .join("");
        }

        private loadProgress(): any {
            // @ts-ignore
            if (!this.subject.config)
                return { runs: [], bestScore: 0, bestStreak: 0 };
            const saved = localStorage.getItem(
                this.subject.config.storageKey || this.subject.id,
            );
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.error(e);
                }
            }
            return { runs: [], bestScore: 0, bestStreak: 0 };
        }

        private getGrade(score: number): string {
            if (score >= 97) return "S+";
            if (score >= 93) return "S";
            if (score >= 90) return "A+";
            if (score >= 87) return "A";
            if (score >= 80) return "B+";
            if (score >= 70) return "C+";
            if (score >= 60) return "D+";
            return "F";
        }

        private formatTime(secs: number): string {
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            return `${m.toString().padStart(2, "0")}:${s.toString().padStart(2, "0")}`;
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        new HomeScreenController();
    });
</script>
