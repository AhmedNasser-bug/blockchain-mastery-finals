---
---
<div class="screen" id="resultsScreen">
    <div class="card results-container" style="text-align:center; padding: 40px;">
        <h2 style="color:var(--text-secondary); letter-spacing: 2px;">MISSION COMPLETE</h2>
        
        <div class="score-ring-container" style="margin: 30px auto; position: relative; width: 200px; height: 200px;">
             <!-- Simplified Ring (CSS Border) -->
            <div class="score-ring" style="width:100%; height:100%; border-radius:50%; border: 10px solid var(--bg-card-hover); position:relative; display:flex; align-items:center; justify-content:center;">
                 <div id="finalGrade" style="font-size: 5rem; font-weight: 900; color: var(--primary);">S</div>
            </div>
             <div id="finalScore" style="position: absolute; bottom: -40px; left: 0; right: 0; font-size: 1.5rem; color: var(--text-muted); font-weight: 700;">100%</div>
        </div>

        <div class="results-stats" style="display:flex; justify-content:center; gap:30px; margin-top: 60px;">
            <div class="stat-item">
                <div class="stat-icon" style="font-size:1.5rem; margin-bottom:5px">‚úÖ</div>
                <div class="stat-val" id="correctCount" style="font-size:1.8rem; font-weight:700; color:var(--success)">0</div>
                <div class="stat-lbl" style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase">Correct</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="font-size:1.5rem; margin-bottom:5px">‚ùå</div>
                <div class="stat-val" id="incorrectCount" style="font-size:1.8rem; font-weight:700; color:var(--error)">0</div>
                <div class="stat-lbl" style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase">Incorrect</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon" style="font-size:1.5rem; margin-bottom:5px">‚è±Ô∏è</div>
                <div class="stat-val" id="finalTime" style="font-size:1.8rem; font-weight:700; color:var(--primary)">00:00</div>
                <div class="stat-lbl" style="font-size:0.8rem; color:var(--text-secondary); text-transform:uppercase">Time</div>
            </div>
        </div>

        <div style="margin-top:50px; display:flex; gap:15px; justify-content:center;">
             <button class="btn btn-secondary" onclick="window.game.showReview()">
                <span>üìù Review</span>
            </button>
            <button class="btn btn-primary" onclick="window.game.goHome()">
                <span>üè† Home</span>
            </button>
        </div>
    </div>

    <div class="card" id="reviewContainer" style="display:none; margin-top:20px;">
        <h3 style="margin-bottom:20px; text-align:center;">DEBRIEF</h3>
        <div id="reviewContent"></div>
         <button class="btn btn-secondary" onclick="document.getElementById('reviewContainer').style.display='none'" style="width:100%; margin-top:20px">Close Review</button>
    </div>
</div>
</div>

<script>
    export interface QuizResults {
        score: number;
        total: number;
        time: number;
        answers: any[];
        maxStreak: number;
    }

    class ResultsScreenController {
        constructor() {
            // @ts-ignore
            window.game = window.game || {};
            // @ts-ignore
            window.game.showResults = this.display.bind(this);
            // @ts-ignore
            window.game.showReview = this.showReview.bind(this);
        }

        display(results: QuizResults): void {
            this.showScreen('resultsScreen');

            const percentage = Math.round((results.score / results.total) * 100);
            
            // Store results temporarily for review button access if needed, or pass it via closure/global
             // @ts-ignore
            window.lastQuizResults = results;

            const elFinalScore = document.getElementById('finalScore');
            if (elFinalScore) elFinalScore.textContent = percentage + '%';

            const elCorrect = document.getElementById('correctCount');
            if (elCorrect) elCorrect.textContent = results.score.toString();

            const elIncorrect = document.getElementById('incorrectCount');
            if (elIncorrect) elIncorrect.textContent = (results.total - results.score).toString();

            const elTime = document.getElementById('finalTime');
            if (elTime) elTime.textContent = this.formatTime(results.time);

            const elGrade = document.getElementById('finalGrade');
            if (elGrade) elGrade.textContent = this.getGrade(percentage);
        }

        showScreen(id: string) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id)?.classList.add('active');
        }

        showReview(): void {
            // @ts-ignore
            const results = window.lastQuizResults;
            if(!results) return;

            const container = document.getElementById('reviewContainer') as HTMLElement;
            if (container) container.style.display = 'block';

            const content = document.getElementById('reviewContent');
            if (content) {
                content.innerHTML = results.answers.map((ans: any, idx: number) => `
                    <div class="review-item ${ans.correct ? 'review-correct' : 'review-incorrect'}">
                        <div class="review-question">${idx + 1}. ${ans.question}</div>
                        <div class="review-answer">Your Answer: ${JSON.stringify(ans.userAnswer)}</div>
                        <div class="review-answer">Correct: ${JSON.stringify(ans.correctAnswer)}</div>
                        <div class="review-answer" style="margin-top:5px;font-style:italic">${ans.explanation}</div>
                    </div>
                `).join('');
            }
        }

        private getGrade(score: number): string {
            const el = document.getElementById('finalGrade');
            let color = 'var(--text-muted)';
            
            if (score >= 97) { color = 'var(--primary)'; return 'S+'; }
            if (score >= 93) { color = 'var(--primary)'; return 'S'; }
            if (score >= 90) { color = 'var(--success)'; return 'A+'; }
            if (score >= 87) { color = 'var(--success)'; return 'A'; }
            if (score >= 80) { color = 'var(--accent-blue)'; return 'B'; }
            if (score >= 70) { color = 'var(--text-primary)'; return 'C'; }
            if (score >= 60) { color = 'var(--accent-purple)'; return 'D'; }
            
            if(el) el.style.color = color;
            return 'F';
        }

        private formatTime(secs: number): string {
            const m = Math.floor(secs / 60);
            const s = secs % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        new ResultsScreenController();
    });
</script>
